# .github/workflows/helm-cypress.yml

name: Helm + Cypress CI

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy to Kind
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kind cluster
      uses: helm/kind-action@v1.8.0
      with:
        node_image: kindest/node:v1.27.3

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.14.0

    - name: Install Ingress Controller
      run: |
        helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
        helm repo update
        helm install ingress-nginx ingress-nginx/ingress-nginx \
          --namespace ingress-nginx \
          --create-namespace \
          --set controller.publishService.enabled=true

        kubectl wait --namespace ingress-nginx \
          --for=condition=Ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=120s

    - name: Deploy Helm Chart with Ingress Enabled
      run: |
        helm install demo demo/app \
          --set ingress.enabled=true \
          --wait

        kubectl get ingress -A

    - name: Save kubeconfig
      run: |
        cp $HOME/.kube/config kubeconfig
      shell: bash

    - name: Upload kubeconfig
      uses: actions/upload-artifact@v4
      with:
        name: kubeconfig
        path: kubeconfig

  test:
    name: Run Cypress Tests
    needs: deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download kubeconfig
      uses: actions/download-artifact@v4
      with:
        name: kubeconfig
        path: $HOME/.kube/

    - name: Set kubeconfig env
      run: echo "KUBECONFIG=$HOME/.kube/kubeconfig" >> $GITHUB_ENV

    - name: Wait for Deployment Ready
      run: |
        kubectl rollout status deployment/my-app --timeout=60s

    - name: Port-forward Ingress
      run: |
        kubectl port-forward --namespace ingress-nginx \
          service/ingress-nginx-controller 8080:80 &
        sleep 10

    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Install Cypress and Dependencies
      run: npm ci  # or `npm install` based on your setup

    - name: Run Cypress Tests
      env:
        CYPRESS_baseUrl: http://localhost:8080
      run: npx cypress run
